<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dropdown-menu.html">

<dom-module id="dropdown-menu-container">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      #dropdownTrigger {
        display: inline-block
      }
    </style>

    <div id="dropdownTrigger" on-tap="_dropdownTriggerTapped">
      <content></content>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict'

  Polymer({

    is: 'dropdown-menu-container',

    properties: {

      noCancelOnOutsideClick: {
        type: Boolean,
        value: false
      },

      opened: {
        type: Boolean,
        value: false,
        observer: '_openedChanged'
      },

      _dropdownMenu: Object,

      _instance: Object

    },

    _openedChanged(opened) {
      if (opened) {
        this._ensureInstance();

        this._dropdownMenu = this.create('dropdown-menu', {
          positionTarget: this,
          noCancelOnOutsideClick: this.noCancelOnOutsideClick,
          onDetach: _ => {
            this.opened = false;
            this._instance = null;
            this._dropdownMenu = null;
          },
          _dropdownContainer: this
        });

        Polymer.dom(this._dropdownMenu).appendChild(this._instance.root);
        this._dropdownMenu.opened = true;
      }
    },

    _ensureInstance() {
      if (!this._instance) {
        const template = Polymer.dom(this).querySelector('template[is="dom-template"]');

        if (!template) {
          throw new Error('dropdown-menu requeres a <template> child');
        }

        template._forwardParentPath = (prop, value) => {
          if (this._instance) {
            this._instance.__setProperty(prop, value, true);
          }
        };

        template._forwardParentProp = (path, value) => {
          if (this._instance) {
            this._instance._notifyPath(path, value, true);
          }
        };

        template.ready();
        this._instance = template.stamp();
      }
    },

    _dropdownTriggerTapped(event) {
      event.preventDefault();
      event.stopPropagation();

      requestAnimationFrame(_ => {
        this.opened = !this.opened;
      });
    }

  });

}());
</script>