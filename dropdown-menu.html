<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

<dom-module id="dropdown-menu-overlay">
  <template>
    <style>
      :host {
        background: white;
        border-radius: 2px;
        box-shadow: 0 1px 20px 2px rgba(0, 0, 0, 0.2);
        transform-origin: top right;
      }

      ::content button {
        background: none;
        border: 0;
        color: initial;
        display: block;
        font-size: 16px;
        outline: 0;
        padding: 14px 20px 14px;
        position: relative;
        text-align: left;
        text-decoration: none;
        width: 100%;
        min-width: 180px;
        cursor: pointer;
      }
    </style>

    <content></content>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'dropdown-menu-overlay',

    behaviors: [
      Polymer.IronOverlayBehavior
    ],

    attached() {
      this.backdropElement.style.opacity = 0;
    },

    _openedChanged() {
      if (this.animation) {
        this.animation.finish();
      }

      Polymer.IronOverlayBehaviorImpl._openedChanged.apply(this, arguments);
    },

    _updateRipples() {
      Polymer.dom(this).children.forEach(el => {
        if ((el.tagName === 'BUTTON' || el.tagName === 'A') && !el._hasRipple) {
          const ripple = this.create('paper-ripple', {
            opacityDecayVelocity: 0.8,
            recenters: true
          });

          ripple.style.color = '#bbb';
          Polymer.dom(el).appendChild(ripple);
          el._hasRipple = true;
        }
      });
    },

    _renderOpened() {
      this.style.pointerEvents = 'none';

      this.animation = this.animate([
        {transform: 'scale(0.3, 0) translate(20px, -10px)'},
        {transform: 'scale(1, 1) translate(0, 0)'}
      ], {
        duration: 240,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      });

      this.animation.onfinish = () => {
        this.style.pointerEvents = '';
        this._finishRenderOpened();

        this.async(_ => {
          this._updateRipples();
        });

        this.animation = null;
      };
    },

    _renderClosed() {
      this.animation = this.animate([
        {opacity: 1},
        {opacity: 0}
      ], {
        duration: 500,
        easing: 'cubic-bezier(0.19, 1, 0.22, 1)'
      });

      this.animation.onfinish = () => {
        this._finishRenderClosed();
        this.animation = null;
      };
    }

  });

}());
</script>

<dom-module id="dropdown-menu">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
  
    <div id="dropdownTrigger" on-tap="_triggerTapped">
      <content></content>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'dropdown-menu',

    properties: {

      _overlayCreated: Boolean

    },

    toggle() {
      this._ensureOverlayCreated();

      requestAnimationFrame(_ => {
        this._overlayElement.toggle();
      });
    },

    _triggerTapped(event) {
      event.preventDefault();
      event.stopPropagation();

      this.toggle();
    },

    _ensureOverlayCreated() {
      if (!this._overlayCreated) {
        // Stamp template with the dropdown-content
        const template = Polymer.dom(this).querySelector('template[is="dom-template"]');
        const instance = template.stamp();

        // Create overlay 
        this._overlayElement = this.create('dropdown-menu-overlay', {
          //horizontalAlign: 'auto',
          verticalAlign: 'top',
          positionTarget: this.$.dropdownTrigger,
          withBackdrop: true
        });

        Polymer.dom(this._overlayElement).appendChild(instance.root);
        document.body.appendChild(this._overlayElement);
        this._overlayCreated = true;
      }
    }

  });

}());
</script>
